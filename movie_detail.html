{% extends "base.html" %}
{% block title %}{{ movie.title }}{% endblock %}

{% block content %}
<div class="row">

  <!-- Columna izquierda -->
  <div class="col-lg-4 col-md-5 mb-4">
    <div class="card bg-secondary text-light mb-3 shadow-sm">

      {% if movie.poster_path %}
        {% if movie.poster_path.startswith('http') %}
          <img src="{{ movie.poster_path }}" class="card-img-top" alt="P√≥ster de {{ movie.title }}">
        {% else %}
          <img src="{{ url_for('static', filename=movie.poster_path) }}" class="card-img-top" alt="P√≥ster de {{ movie.title }}">
        {% endif %}
      {% elif movie.tmdb_data and movie.tmdb_data.poster_path %}
        <img src="https://image.tmdb.org/t/p/w500{{ movie.tmdb_data.poster_path }}" class="card-img-top" alt="P√≥ster de {{ movie.title }}">
      {% else %}
        <img src="{{ url_for('static', filename='img/default_poster.jpg') }}" class="card-img-top" alt="Sin p√≥ster">
      {% endif %}

      <div class="card-body">
        <h3 class="card-title">{{ movie.title }}</h3>
        {% if movie.year %}<p><strong>A√±o:</strong> {{ movie.year }}</p>{% endif %}
        {% if movie.director %}<p><strong>Director:</strong> {{ movie.director }}</p>{% endif %}
        {% if movie.genres %}<p><strong>G√©neros:</strong> {{ movie.genres | join(', ') }}</p>{% endif %}

        <!-- Calificaciones -->
        <p>
          <strong>‚≠ê Calificaci√≥n usuarios:</strong>
          {{ avg_rating if avg_rating else 'Sin calificaciones locales' }}<br>
          {% if movie.tmdb_data and movie.tmdb_data.vote_average %}
            <strong>üåê TMDB:</strong> {{ movie.tmdb_data.vote_average }}/10
          {% endif %}
        </p>
      </div>
    </div>

    <!-- Trailer -->
    {% if movie.trailer_url %}
      <div class="mb-3 text-center">
        <h5>üé¨ Tr√°iler</h5>
        <div class="ratio ratio-16x9 mb-2">
          <iframe 
            src="{{ movie.trailer_url | replace('watch?v=', 'embed/') }}" 
            title="Tr√°iler de {{ movie.title }}" 
            allowfullscreen></iframe>
        </div>
        <a href="{{ movie.trailer_url }}" target="_blank" class="watchlist-button">Ver en YouTube</a>
      </div>
    {% else %}
      <p class="text-center text-muted">No hay tr√°iler disponible</p>
    {% endif %}
  </div>

  <!-- Columna derecha -->
  <div class="col-lg-8 col-md-7">

    {% if is_admin %}
      <div class="mb-3 text-end">
        <a href="{{ url_for('admin_edit_movie', movieId=movie.movieId) }}" class="watchlist-button">‚úèÔ∏è Editar Pel√≠cula</a>
      </div>
    {% endif %}

    {% if ratings_graph %}
      <div class="mb-4">
        <h4>Distribuci√≥n de Calificaciones</h4>
        <img src="data:image/png;base64,{{ ratings_graph }}" alt="Gr√°fica de calificaciones" class="img-fluid rounded shadow-sm">
      </div>
    {% endif %}

    {% if 'user_id' in session %}
      <div class="card mb-4 bg-dark text-light p-3 shadow-sm">
        <h5>Agregar rese√±a</h5>
        <form method="POST" action="{{ url_for('rate_movie', movieId=movie.movieId) }}">
          <div class="mb-2">
            <label>Calificaci√≥n (0 a 10)</label>
            <input name="rating" type="number" min="0" max="10" step="0.1" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Rese√±a</label>
            <textarea name="review_text" class="form-control" rows="3" placeholder="Escribe tu rese√±a aqu√≠..."></textarea>
          </div>
          <button type="submit" class="watchlist-button">Enviar rese√±a</button>
        </form>
      </div>
    {% endif %}

    <!-- Rese√±as locales -->
    <h4 class="mb-3">üìù Rese√±as de usuarios</h4>

    {% if reviews %}
      <div class="d-flex flex-column gap-3">
        {% for r in reviews %}
          <div class="card bg-dark text-light shadow-sm border-0 p-3">
            <div class="d-flex align-items-center mb-2">
              <!-- Avatar inicial -->
              <div class="rounded-circle bg-secondary text-center text-light me-3" style="width:40px; height:40px; line-height:40px; font-weight:bold;">
                {{ r.username[0]|upper }}
              </div>

              <!-- Nombre con enlace -->
              <div>
                <a href="{{ url_for('user_profile', username=r.username) }}" class="text-light fw-bold text-decoration-none">
                  {{ r.username }}
                </a><br>
                <small class="text-muted">
                  {{ r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at else 'Sin fecha' }}
                </small>
              </div>
            </div>

            <!-- Calificaci√≥n y texto -->
            <div class="ps-1">
              <p class="mb-1"><strong>‚≠ê {{ r.rating }}/10</strong></p>
              <p class="mb-0">{{ r.text }}</p>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">No hay rese√±as locales todav√≠a. ¬°S√© el primero en opinar!</p>
    {% endif %}
  </div>
</div>
{% endblock %}
